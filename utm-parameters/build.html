<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>链接构建工具</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
  <style>
    .pure-form input[type=text],
    .pure-form select {
      box-shadow: none;
    }
    .pure-control-group.focus {
      position: relative;
    }
    .pure-control-group.focus:before {
      border: 1px solid #129FEA;
      border-radius: 4px;
      content: "";
      display: block;
      height: 112%;
      left: 2%;
      position: absolute;
      top: -8%;
      width: 94%;
      z-index: -1;
    }
    .text-muted {
      color: #818a91;
    }
    .help-text {
      display: block;
      margin: 0 0 0 11.6rem;
      padding: 0.5em 0 0;
    }
  </style>
</head>
<body>
  <div class="pure-g">
    <div class="pure-u-1">
      <form class="pure-form pure-form-aligned url-builder">
        <div class="pure-controls">
          <h2>UTM 参数链接构建工具</h2>
        </div>
        <fieldset>
          <div class="pure-control-group">
            <label for="link">
              原始链接<br>
              <small class="text-muted">link</small>
            </label>
            <input type="url" name="link" placeholder="https://simplecms.xiachufang.com/posts/1234/" style="width: 50%" required>
            <small class="text-muted help-text">
              <strong>必填</strong> -
              目标页面的原始链接
            </small>
          </div>

          <div class="pure-control-group">
            <label for="">
              强制使用 HTTPS<br>
              <small class="text-muted">force https</small>
            </label>
            <input type="checkbox" name="https" checked>
            <small class="text-muted help-text">
              <strong>建议</strong> -
              生成 HTTPS 链接防止运营商劫持
            </small>
          </div>

          <div class="pure-control-group">
            <label for="utm_campaign">
              广告名称<br>
              <small class="text-muted">utm_campaign</small>
            </label>
            <input type="text" name="utm_campaign" placeholder="20160520yiguo" required>
            <small class="text-muted help-text">
              <strong>必填</strong> -
              用于区分具体某个推广项目，比如某场电商、市场活动，厨房周刊某期，应尽量简明、准确：<code>weekly236</code> / <code>2016-717</code> / <code>20160520yiguo</code>
            </small>
          </div>

          <div class="pure-control-group">
            <label for="utm_medium">
              广告媒介<br>
              <small class="text-muted">utm_medium</small>
            </label>
            <select name="utm_medium" required>
              <option value="">请选择...</option>

              <optgroup label="App">
                <option value="issue">App 首页瀑布流 (issue)</option>
                <option value="push">推送 (push)</option>
                <option value="event">话题描述 (event)</option>
                <option value="ectabbig">市集独占 (ectabbig)</option>
              </optgroup>

              <optgroup label="社交平台">
                <option value="weibo">单条微博 (weibo)</option>
                <option value="weixinmp_article">公众号文章 (weixinmp_article)</option>
                <option value="weixinmp_btn">公众号菜单 (weixinmp_btn)</option>
                <option value="liveroom">下厨房直播间 (liveroom)</option>
              </optgroup>

              <optgroup label="App 广告位">
                <option value="splash_ad">App 闪屏 (splash_ad)</option>
                <option value="launch_ad">App 开屏 (launch_ad)</option>
                <option value="recipe_bottom_text_ad">App 菜谱底部文字广告 (recipe_bottom_text_ad)</option>
                <option value="homepage_banner_ad1">App 首页 Banner 1# (homepage_banner_ad1)</option>
                <option value="homepage_banner_ad2">App 首页 Banner 2# (homepage_banner_ad2)</option>
                <option value="issue_ad1">App 首页 Issue 广告位 1# (issue_ad1)</option>
                <option value="issue_ad2">App 首页 Issue 广告位 2# (issue_ad2)</option>
                <option value="buy_baking_banner_ad1">买烘焙 Banner 1# (buy_baking_banner_ad1)</option>
                <option value="universal_search_banner_ad1">综合搜索 Banner 1# (universal_search_banner_ad1)</option>
              </optgroup>

              <optgroup label="百度 SSP 广告位">
                <option value="mobile_bottom_ad">M 站底部横通 (mobile_bottom_ad)</option>
                <option value="pc_bottom_ad">PC 底部横通 (pc_bottom_ad)</option>
              </optgroup>
            </select>
            <small class="text-muted help-text">
              <strong>必填</strong> -
              用于区分流量媒介，亦即流量入口具体是种什么东西，比如不同类型的广告位、微博
            </small>
          </div>

          <div class="pure-control-group">
            <label for="utm_source">
              广告来源<br>
              <small class="text-muted">utm_source</small>
            </label>
            <input type="text" name="utm_source" placeholder="xiachufang" value="xiachufang" required>
            <small class="text-muted help-text">
              <strong>必填</strong> -
              用于区分流量的来源，媒介由谁控制，来源就是谁，亦即媒介的控制者，比如下厨房、某个具体合作伙伴：<code>xiachufang</code> / <code>xiaomi</code> / <code>smzdm</code>
            </small>
          </div>

          <div class="pure-control-group">
            <label for="utm_content">
              广告内容<br>
              <small class="text-muted">utm_content</small>
            </label>
            <input type="text" name="utm_content">
            <small class="text-muted help-text">
              <strong>选填</strong> -
              用于 A/B 测试或用于区分同一次推广、同一种媒介上的不同广告，比如 717 每天的开屏：<code>717-launch1</code> / <code>717-launch2</code> / <code>717-launch2-emoji</code>
            </small>
          </div>

          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">生成链接</button>
          </div>
        </fieldset>
      </form>
    </div>
    <div class="pure-u-1">
      <pre style="padding: 1em; background: #f7f7f7"><code id="result">&nbsp;</code></pre>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.1.6/zepto.min.js"></script>
  <script>
    (function () {
      // add form submit listener for generating url
      $('form.url-builder').submit(function (e) {
        e.preventDefault()

        var $this = $(this)
        var f = {}

        $.each($this.serializeArray(), function (i, el) {
          f[el.name] = el.value
        })

        if (!f.link || !f.utm_campaign || !f.utm_medium || !f.utm_source)
          return console.log('missing required fileds')

        var params = {
          utm_source: f.utm_source,
          utm_medium: f.utm_medium,
          utm_campaign: f.utm_campaign,
        }

        if (!!f.utm_content)
          params.utm_content = f.utm_content

        var a = document.createElement('a')
        a.href = f.link
        a.search = [a.search, $.param(params)]
          .filter(function (el) {return !$.isEmptyObject(el)})
          .join('&')

        if (!!f.https)
          a.protocol = 'https:'

        $('code#result').text('<!-- ' + f.utm_medium + ' -->\n' + a.href)
      })

      // on-demand build
      $(function () {
        try {
          var f = JSON.parse(atob(location.hash.substring(1)))
        } catch (e) {
          return console.log('no on-demand build or bad hash')
        }

        // clear hash
        history.replaceState('', document.title, window.location.pathname);

        $('input[name=link]').val(f.link)
        $('input[name=utm_campaign]').val(f.utm_campaign)

        $('select[name=utm_medium] option').each(function (index, item) {
          if (item.value === f.utm_medium)
            item.selected = true
        })

        $('input[name=utm_source]').val(f.utm_source)
        $('form.url-builder button[type=submit]').click()

        // highlight utm_medium on succussful build
        if (!f.link || !f.utm_campaign || !f.utm_medium || !f.utm_source)
          return
        var $highlight = $('select[name=utm_medium]').parent()
        // blink effect
        var interval = setInterval(function () { $highlight.toggleClass('focus')}, 100)
        setTimeout(function () { clearInterval(interval) }, 900)
        // clear highlight eventually
        setTimeout(function () { $('.pure-control-group.focus').removeClass('focus')}, 7000)
      })
    })();
  </script>
</body>
</html>
